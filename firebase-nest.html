<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-query.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">
<!--
`firebase-nest` is a wrapper element around firebase-query and designed to work well with `firebase-value`.


@demo demo/index.html 
-->
<dom-module id="firebase-nest">
  <template>
    <firebase-query id="query" log="[[log]]" size="{{size}}" order-by-child="[[orderByChild]]" order-by-value="[[orderByValue]]" start-at="[[startAt]]" end-at="[[endAt]]" equal-to="[[equalTo]]" limit-to-first="[[limitToFirst]]" limit-to-last="[[limitToLast]]" data="{{data}}" disabled="[[disabled]]" path="[[path]]" log="[[log]]" app="[[app]]" app-name="[[appName]]"></firebase-query>
    <content></content>
  </template>
  <script>
  Polymer({

    is: 'firebase-nest',

    behaviors: [
      Polymer.FirebaseCommonBehavior
    ],

    properties: {

      /**
       * Path to a Firebase root or endpoint. N.B. `path` is case sensitive.
       */
      path: {
        type: String
      },

      /**
       * The data to returned by firebase-query.
       */
      data: {
        type: Array,
        notify: true
      },

      /* 
       * `dataSource`  Function that provides items lazily. Receives arguments params, callback
       *     params.page Requested page index
       *     params.pageSize Current page size
       *     params.filters Currently applied filters
       *     params.sortOrders Currently applied sorting orders
       */
      dataSource: {
        notify: true,
        value: function() {
          return this._dataSource.bind(this);
        }
      },

      /**
       * When true, Firebase listeners won't be activated. This can be useful
       * in situations where elements are loaded into the DOM before they're
       * ready to be activated (e.g. navigation, initialization scenarios).
       */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
       * When true, will perform detailed logging.
       */
      log: {
        type: Boolean,
        value: false
      },

      /**
       * `size` reflect data.length. Size is debounced in firebase-query
       */
      size: {
        type: Number,
        notify: true
      },

      /* 
       * `allowSync`  set to true to make sure we sync with firebase. It HAS to be set to true if we are using two-way binding with dom-repeat ...
       */
      // allowSync: {
      //   type: Boolean,
      //   value: false
      // },

      /**
       * The child key of each query result to order the query by.
       *
       * Changing this value generates a new `query` ordered by the
       * specified child key.
       */
      orderByChild: {
        type: String,
        value: ''
      },

      /**
       * Order this query by values. This is only applicable to leaf node queries
       * against data structures such as `{a: 1, b: 2, c: 3}`.
       */
      orderByValue: {
        type: Boolean,
        value: false
      },

      /**
       * The value to start at in the query.
       *
       * Changing this value generates a new `query` with the specified
       * starting point. The generated `query` includes children which match
       * the specified starting point.
       */
      startAt: {
        type: String,
        value: ''
      },

      /**
       * The value to end at in the query.
       *
       * Changing this value generates a new `query` with the specified
       * ending point. The generated `query` includes children which match
       * the specified ending point.
       */
      endAt: {
        type: String,
        value: ''
      },

      /**
       * Specifies a child-key value that must be matched for each candidate result.
       *
       * Changing this value generates a new `query` which includes children
       * which match the specified value.
       */
      equalTo: {
        type: Object,
        value: null
      },

      /**
       * The maximum number of nodes to include in the query.
       *
       * Changing this value generates a new `query` limited to the first
       * number of children.
       */
      limitToFirst: {
        type: Number,
        value: 0
      },

      /**
       * The maximum number of nodes to include in the query.
       *
       * Changing this value generates a new `query` limited to the last
       * number of children.
       */
      limitToLast: {
        type: Number,
        value: 0
      }
    },

    listeners: {
      // 'firebase-value': 'onFirebaseValue'
    },

    attached: function() {
      // IMPORTANT !
      //we Highjack the behavior of firebase-query and prevent data to be written back to the db. If need be, we could go back to standard behavior depending on allowSync
      this.$.query.__dataChanged = function() {};
    },

    _dataSource: function(opts, cb) {
      var items = this.data;
      if (opts.filters.length) {
        items = this._filter(items, opts.filters);
      }
      this.size = items.length;

      if (opts.sortOrders.length) {
        items = this._sort(items, opts.sortOrders);
      }

      var start = opts.page * opts.pageSize;
      var end = start + opts.pageSize;
      var slice = items.slice(start, end);
      cb(slice, items.length);
    },

    _sort: function(items, sorters) {
      this._sorters = sorters;
      return items.sort(this._multiSort.bind(this));

    },

    _multiSort: function(a, b) {
      return this._sorters.map(function(sort) {
        if (sort.direction === 'asc') {
          return this._compare(Polymer.Base.get(sort.path, a), Polymer.Base.get(sort.path, b));
        } else if (sort.direction === 'desc') {
          return this._compare(Polymer.Base.get(sort.path, b), Polymer.Base.get(sort.path, a));
        }
        return 0;
      }, this).reduce(function firstNonZeroValue(p, n) {
        return p ? p : n;
      }, 0);
    },

    _normalizeEmptyValue: function(value) {
      return [undefined, null].indexOf(value) >= 0 ? '' : value.toString();
    },

    _compare: function(a, b) {
      a = this._normalizeEmptyValue(a);
      b = this._normalizeEmptyValue(b);

      if (a < b) {
        return -1;
      }
      if (a > b) {
        return 1;
      }
      return 0;
    },

    _filter: function(items, filters) {
      return items.filter(function(item, index) {
        return filters.filter(function(filter) {
          var value = this._normalizeEmptyValue(Polymer.Base.get(filter.path, item));
          return value.toLowerCase().indexOf(filter.value.toString().toLowerCase()) === -1;
        }.bind(this)).length === 0;
      }, this);
    },

    /*
    onFirebaseValue: function(e, d) {
      e.stopPropagation();

      var firebaseKey = d.$key,
        index = this.data.findIndex(function(d) {
          return d.$key === firebaseKey;
        });

      //hack to prevent the change to be reflected to firebase !
      this.$.query.__syncingToMemory = true;
      this.set(['data', index].concat(d.key), d.value);
      // this.notifyPath(['data', index]);
      this.$.query.__syncingToMemory = false;

      // if(this._useDataSource) {
      //   this.fire('firebase-item-changed', {
      //     item: this.data[index],

      //   })
      // }
      // we might need to refresh some stuff based on this;
      // console.info('NEST', d);
      this.debounce('firebase-nest-refresh', function() {
        // console.info('FIRE NEST', d);
        // console.timeStamp('nest');
        this.fire('firebase-nest-refresh', this.data);
      }, 200);
    }
    */

    /*
      _computeDataAsObject: function(splices) {
      if (splices && splices.indexSplices) {
        splices.indexSplices.forEach(function(s) {
          s.removed.forEach(function(removed) {
            //work around this.delete not implemented https://github.com/Polymer/polymer/issues/2565
            delete(this.dataAsObject[removed.$key]);
            this.notifyPath('dataAsObject.' + removed.$key);
          });
          for (var i = 0; i < s.addedCount; i++) {
            var index = s.index + i;
            var obj = s.object[index];
            this.set('dataAsObject.' + obj.$key, obj);
          }
        }, this);
      }
    }
    */
  });
  </script>
</dom-module>
