<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">
<link rel="import" href="firebase-value-behavior.html">
<!--
`firebase-value` is a wrapper around firebase-document, firing `firebase-value` when value is being retrieved.

@demo demo/index.html 
@event firebase-value
-->
<dom-module id="firebase-value">
  <template>
    <firebase-document log="[[log]]" exists="{{exists}}" data="{{value}}" path="[[path]]" disabled="[[disabled]]" app-name="[[appName]]"></firebase-document>
  </template>
  <script>
  Polymer({

    is: 'firebase-value',

    behaviors: [
      Polymer.firebaseNest.ValueBehavior
    ],

    properties: {

      path: {
        type: String,
        reflectToAttribute: true
      },

      /**
       * The data to returned by firebase-document.
       */
      value: {
        type: Object,
        notify: true
      },

      /**
       * `data` root data that this element will augment
       */
      data: {
        type: Object,
        notify: true
      },

    },

    observers: [
      // 'observeData(value, keyArray, data)',
      // '_observeValueChangeSimple(value)',
      '_observeValueChange(data, value.*)',
      '_observeExistsChange(data, exists)'
    ],

    // getValue: function(value) {
    //   return (this.exists === true ||  this.defaultValue === undefined) ? value : this.defaultValue;
    // },

    _observeExistsChange: function(data, exists) {
      // console.info('CHANGED EXISTS 0', exists, this.key, this.value);
      if (exists === true) {
        // console.info('CHANGED EXISTS 1', this.key, this.value);
        return this.set('data.' + this.key, this.value);
      }
      if (exists === false && this.defaultValue) {
        return this.set('data.' + this.key, this.defaultValue);

      }
    },

    // _observeValueChangeSimple: function(value) {
    //   console.info('CHANGED SIMPLE', value);
    // },

    _observeValueChange: function(data,changed) {
      // console.info('CHANGED 0', changed, this.value);
      if (this.exists) {
        // console.info('CHANGED 1', 'data.' + [this.key].concat(changed.path.split('.').splice(1)).join('.'), changed, changed.value);
        this.set('data.' + [this.key].concat(changed.path.split('.').splice(1)).join('.'), changed.value);

      }
    }
  });
  </script>
</dom-module>
