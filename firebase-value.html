<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="firebase-value-behavior.html">
<!--
`firebase-value` is a wrapper around firebase-document allowing to link firebase data
-->
<dom-module id="firebase-value">
  <template>
    <firebase-document log="[[log]]" exists="{{exists}}" data="{{firebaseData}}" path="[[path]]" disabled="[[disabled]]" app="[[app]]" app-name="[[appName]]"></firebase-document>
  </template>
  <script>
  Polymer({

    is: 'firebase-value',

    behaviors: [
      Polymer.firebaseNest.firebaseValue
    ],

    observers: [
      '_observeExistsChange(data, exists)',
      '_observeFirebasePrimitiveChange(firebaseData, data)'
    ],

    detached: function() {
      this.unlinkPaths('firebaseData');
    },

    _observeExistsChange: function(data, exists) {
      if (!this.key) {
        return this._error('missing key');
      }
      if (exists === true) {
        // check if firebaseData is primitive - in this case linkPaths will not work !
        this._previousExists = exists;
        if (Object(this.firebaseData) !== this.firebaseData) {
          this.unlinkPaths('firebaseData');
          this._set_isPrimitive(true);
          this.set('data.' + this.key, this.firebaseData);
          this.debounceFire();
          return;
        }
        this.set('data.' + this.key, this.firebaseData);
        this.linkPaths('firebaseData', 'data.' + this.key);
        return this.debounceFire();

      }
      if ((exists === false || this._previousExists) && (this.defaultValue !== undefined)) {
        this._previousExists = exists;
        return this.set('data.' + this.key, this.defaultValue);
      }
    },

    _observeFirebasePrimitiveChange: function(firebaseData, data) {
      // XXX(cg): we need a similar mechanism event if not primitive. 
      if (this._isPrimitive && this.exists) {
        this.set('data.' + this.key, this.firebaseData);
        this.debounceFire();
      }
    }

  });

  </script>
</dom-module>

