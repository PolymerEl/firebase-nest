<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">
<!--
`firebase-value` is a wrapper around firebase-document allowing to link firebase data
-->
<dom-module id="firebase-value">
  <template>
    <style>
     :host {
      display: inline;
    }
    </style>
    <firebase-document log="[[log]]" exists="{{exists}}" data="{{firebaseData}}" path="[[path]]" disabled="[[disabled]]" app="[[app]]" app-name="[[appName]]"></firebase-document>
    <template is="dom-if" if="[[show]]">
      <template is="dom-if" if="[[exists]]">[[firebaseData]]</template>
    </template>
  </template>
  <script>
  Polymer({

    is: 'firebase-value',

    behaviors: [
      Polymer.FirebaseCommonBehavior
    ],

    properties: {

      /**
       * The data to returned by firebase-document.
       */
      firebaseData: {
        type: Object
      },

      /**
       * `data` root data that this element will enrich
       */
      data: {
        type: Object,
        notify: true
      },

      /**
       * `key` the key to add to passed data. the observer links `value` (e.g. data from firebase) to `data[key]`
       */
      key: {
        type: String,
        value: 'lookup'
      },

      /**
       * Path to a Firebase root or endpoint. N.B. `path` is case sensitive.
       */
      path: {
        type: String
      },

      /**
       * When true, Firebase listeners won't be activated. This can be useful
       * in situations where elements are loaded into the DOM before they're
       * ready to be activated (e.g. navigation, initialization scenarios).
       */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
       * When true, will perform detailed logging.
       */
      log: {
        type: Boolean,
        value: false
      },

      /**
       * `exists` notify us when we have data
       */
      exists: {
        type: Boolean
      },

      /* 
       * `defaultValue` the value to set as default when data does not exists at firebase level.
       */
      defaultValue: {
        type: Object
      },


      /* 
       * `_isPrimitive`  a flag for when firebaseData is primitive. 
       */
      _isPrimitive: {
        type: Boolean,
        readOnly: true
      },

      /* 
       * `show` set true to display the value of firebase data. Mostly usefull when we read primitive String and just want to display them.
       */
      show: {
        type: Boolean
      }

    },

    observers: [
      '_observeExistsChange(data, exists)',
      '_observeFirebasePrimitiveChange(firebaseData, data)'
    ],

    detached: function() {
      this.unlinkPaths('firebaseData');
    },

    _observeExistsChange: function(data, exists) {
      if (!this.key) {
        return this._error('missing key');
      }
      if (exists === true) {
        // console.info('DB CHANGE', data, this.firebaseData);
        // check if firebaseData is primitive - in this case linkPaths will not work !
        if (Object(this.firebaseData) !== this.firebaseData) {
          this.unlinkPaths('firebaseData');
          this._set_isPrimitive(true);
          return this.set('data.' + this.key, this.firebaseData);
        }
        if (this.data && this.data[this.key]) {
          this._warn('key (' + this.key + ') is already defined ', this.data);
        }
        this.set('data.' + this.key, this.firebaseData);
        this.linkPaths('firebaseData', 'data.' + this.key);
      }
      if (exists === false && (this.defaultValue !== undefined)) {
        return this.set('data.' + this.key, this.defaultValue);
      }
    },

    _observeFirebasePrimitiveChange: function(firebaseData, data) {
      if (this._isPrimitive && this.exists) {
        this.set('data.' + this.key, this.firebaseData);
      }
    }
  });
  </script>
</dom-module>