<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-document.html">
<link rel="import" href="firebase-value-behavior.html">
<!--
`firebase-value` is a wrapper around firebase-document allowing to link firebase data
-->
<dom-module id="firebase-value">
  <template>
    <firebase-document log="[[log]]" exists="{{exists}}" data="{{firebaseData}}" path="[[path]]" disabled="[[disabled]]" app="[[app]]" app-name="[[appName]]"></firebase-document>
  </template>
  <script>
  Polymer({

    is: 'firebase-value',


    behaviors: [
      Polymer.firebaseNest.firebaseValue
    ],

    observers: [
      '_observeExistsChange(data, exists)',
      '_observeFirebasePrimitiveChange(firebaseData, data)'
      // '_temp(firebaseData.*)'
    ],

    detached: function() {
      this.unlinkPaths('firebaseData');
    },

    // _temp: function(changed) {
    //   console.info(changed)
    // },

    _observeExistsChange: function(data, exists) {
      if (!this.key) {
        return this._error('missing key');
      }
      if (exists === true) {
        // check if firebaseData is primitive - in this case linkPaths will not work !
        this._previousExists = exists;
        if (Object(this.firebaseData) !== this.firebaseData) {
          this.unlinkPaths('firebaseData');
          this._set_isPrimitive(true);
          this.set('data.' + this.key, this.firebaseData);
          this.debounceFire();
          return;
        }
        // this.set('data.' + this.key, this.firebaseData);
        // this.data[this.key] = this.firebaseData;
        // this.notifyPath(`data.${this.key}`);
        // Object.keys(this.firebaseData).forEach(k => {
        //   this.linkPaths(`data.${this.key}.${k}`, `firebaseData.${k}`);
        // })
        // this.linkPaths(`data.${this.key}`, 'firebaseData');
        this.linkPaths(`data.${this.key}`, 'firebaseData');
        // this.debounceFire();
        return

      }
      if ((exists === false || this._previousExists) && (this.defaultValue !== undefined)) {
        this._previousExists = exists;
        return this.set('data.' + this.key, this.defaultValue);
      }
    },

    /**
     * Method called to determine whether a property value should be
     * considered as a change and cause the `_propertiesChanged` callback
     * to be enqueued.
     *
     * The default implementation returns `true` if a strict equality
     * check fails. The method always returns false for `NaN`.
     *
     * Override this method to e.g. provide stricter checking for
     * Objects/Arrays when using immutable patterns.
     *
     * @param {string} property Property name
     * @param {*} value New property value
     * @param {*} old Previous property value
     * @return {boolean} Whether the property should be considered a change
     *   and enqueue a `_proeprtiesChanged` callback
     * @protected
     */
    _shouldPropertyChange: function(property, value, old) {

      if (property.startsWith('firebaseData.') && old) {
        // Note(cg): makes sure data reflects firebase value, without notifying anyone.
        // this is hacky but prevents that changes on bountPath are propagated twice 
        // leading to value not being updated
        // https://gitlab.furqansoftware.net/preignition/preignition/issues/1062

        if (Polymer.Path.isPath(this.key)) {
          this.set('data.' + this.key, this.firebaseData);
        }
        else {
          this.data[this.key] = this.firebaseData;
        }
        return false
      };

      // Note(cg): changes happening at base level are not caught in linked-paths.
      if (property === 'firebaseData') {
        this.set('data.' + this.key, value);
        this.debounceFire();
      }

      return (
        // Strict equality check
        (old !== value &&
          // This ensures (old==NaN, value==NaN) always returns false
          (old === old || value === value))
      );
    },

    _observeFirebasePrimitiveChange: function(firebaseData, data) {
      // XXX(cg): we need a similar mechanism event if not primitive. 
      if (this._isPrimitive && this.exists) {
        this.set('data.' + this.key, this.firebaseData);
        this.debounceFire();
      }
    }

  });

  </script>
</dom-module>
